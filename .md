# Fluxo de Cache para Reconhecimento de Logotipo

## Resumo do fluxo

1. Captura da imagem e geração de hash único (ex: SHA-256 do base64).
2. Consulta ao cache local (SQLite ou AsyncStorage) usando o hash.
3. Se existir no cache: retorna o resultado salvo.
4. Se não existir: faz a requisição à API, salva o resultado no cache e exibe ao usuário.

## Como implementar

- Use o pacote `expo-sqlite` para criar e consultar o banco local.
- Use uma biblioteca de hash, como `js-sha256`, para gerar o hash da imagem.
- No botão "Buscar", antes de chamar a API, consulte o banco usando o hash.
- Se não houver resultado, chame a API, salve o retorno no banco e exiba.

## Exemplo de funções principais

```typescript
import * as SQLite from 'expo-sqlite';
import { sha256 } from 'js-sha256';

const db = SQLite.openDatabase('logos.db');

export function initLogoCache() {
    db.transaction(tx => {
        tx.executeSql(
            'CREATE TABLE IF NOT EXISTS logos (image_hash TEXT PRIMARY KEY, api_response TEXT, timestamp INTEGER);'
        );
    });
}

export async function getLogoFromCache(imageBase64: string) {
    const hash = sha256(imageBase64);
    return new Promise((resolve) => {
        db.transaction(tx => {
            tx.executeSql(
                'SELECT api_response FROM logos WHERE image_hash = ?;',
                [hash],
                (_, { rows }) => resolve(rows.length ? JSON.parse(rows.item(0).api_response) : null)
            );
        });
    });
}

export async function saveLogoToCache(imageBase64: string, apiResponse: any) {
    const hash = sha256(imageBase64);
    const timestamp = Date.now();
    db.transaction(tx => {
        tx.executeSql(
            'INSERT OR REPLACE INTO logos (image_hash, api_response, timestamp) VALUES (?, ?, ?);',
            [hash, JSON.stringify(apiResponse), timestamp]
        );
    });
}
```

## No fluxo do modal

- Gere o base64 da imagem capturada.
- Consulte o cache antes de chamar a API.
- Salve o resultado após a chamada.

## Observação

- Instale as dependências:
    ```sh
    expo install expo-sqlite
    npm install js-sha256
    ```
- Inicialize o banco no início do app (`initLogoCache()`).

## Conclusão

Esse padrão é eficiente, escalável e muito usado em apps que consomem APIs pagas ou lentas.

Sugestão de ajuste no fluxo:

Captura da imagem
Consulta ao cache local
Se não existir no cache, chama a API
Se a API reconhecer a logomarca:
Salva o retorno (dados da logo, arquivo, etc.) no histórico/cache.
Permite ao usuário acessar e reutilizar esse conteúdo em outros locais do app.
Se a API não reconhecer, não salva no histórico.
Exemplo de lógica:

No histórico/cache, salve:

Hash da imagem
Dados da logomarca reconhecida (nome, arquivo, url, etc.)
Timestamp
Resumo:

Só salve no histórico se a logomarca for reconhecida.
Permita que o usuário acesse e reutilize o conteúdo reconhecido em diferentes partes do app.

```typescript
const apiResponse = await sendToGoogleVision(imageBase64);

if (apiResponse && apiResponse.logoRecognized) {
    await saveLogoToCache(imageBase64, apiResponse);
    // Exibe conteúdo associado normalmente
} else {
    // Exibe tela/modal informando "Sem conteúdo associado"
    setShowNoContentModal(true); // Exemplo de estado para abrir o modal
}
```

Você pode implementar essa regra exibindo uma tela ou modal informando "Sem conteúdo associado" quando a API não reconhecer a logomarca.

Sugestão de fluxo:

Resumo:

Se não reconhecer, não salva no histórico.
Exibe uma tela/modal informando ao usuário que não há conteúdo associado à imagem.